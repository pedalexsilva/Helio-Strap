<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Amazfit HR</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#ffffff" />
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol','Noto Color Emoji'; 
         padding: 24px; background:#fafafa; color:#111; display:flex; justify-content:center; }
  .card { background:#fff; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.08); padding:22px; max-width:560px; width:100%; }
  h1 { margin:0 0 8px; font-size:1.6rem; }
  p  { margin:0 0 16px; color:#444; }
  button { font-size:1.05rem; padding:12px 16px; border-radius:12px; border:0; cursor:pointer; }
  button.primary { background:#2563eb; color:#fff; }
  #status { margin-top:14px; color:#111; font-size:0.95rem; min-height:1.4em; }
  .metrics { font-size:1.4rem; margin-top:12px; }
  #log { margin-top:12px; background:#0b1020; color:#a7f3d0; padding:10px; border-radius:10px; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; 
         max-height:200px; overflow:auto; }
</style>
</head>
<body>
  <div class="card">
    <h1>Amazfit Helio Strap</h1>
    <p>Web Bluetooth ‚Ä¢ Chrome Android ‚Ä¢ Leitura √∫nica</p>
    <button id="btnOnce" class="primary">üîó Ler HR e Bateria</button>
    <div class="metrics">‚ù§Ô∏è <span id="hr">‚Äî</span> bpm &nbsp;|&nbsp; üîã <span id="batt">‚Äî</span>%</div>
    <div id="status">Pronto.</div>
    <div id="log"></div>
  </div>

<script>
const SVC_HR   = 'heart_rate';               // 0x180D
const CH_HR_ME = 'heart_rate_measurement';   // 0x2A37
const SVC_BATT = 'battery_service';          // 0x180F
const CH_BATT  = 'battery_level';            // 0x2A19

let device=null, server=null, hrChar=null, battChar=null;

const $hr = document.getElementById('hr');
const $batt = document.getElementById('batt');
const $status = document.getElementById('status');
const $log = document.getElementById('log');

function log(line){ console.log(line); $log.textContent += line + "\n"; $log.scrollTop = $log.scrollHeight; }
function setStatus(t){ $status.textContent = t; }

async function ensureNotifPermission() {
  if (!('Notification' in window)) return false;
  if (Notification.permission === 'granted') return true;
  if (Notification.permission !== 'denied') {
    const res = await Notification.requestPermission();
    return res === 'granted';
  }
  return false;
}
function notifyLine(hr,batt){
  if (!('Notification' in window) || Notification.permission !== 'granted') return;
  const body = `‚ù§Ô∏è ${hr ?? '‚Äî'} bpm | üîã ${batt ?? '‚Äî'}%`;
  new Notification(body, { body });
}

function parseHeartRate(dv){
  const flags = dv.getUint8(0);
  const is16 = (flags & 0x01) === 1;
  return is16 ? dv.getUint16(1, true) : dv.getUint8(1);
}

async function disconnect(){
  try { if (device?.gatt?.connected) await device.gatt.disconnect(); } catch {}
  device=null; server=null; hrChar=null; battChar=null;
  log('Desconectado.');
}

async function readOnce(){
  try{
    if (!navigator.bluetooth){ alert('Este browser n√£o suporta Web Bluetooth. Use o Chrome/Edge Android.'); return; }
    await ensureNotifPermission();
    setStatus('A procurar o dispositivo...');
    $log.textContent='';

    device = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: 'Amazfit' }],
      optionalServices: [SVC_HR, SVC_BATT]
    });
    device.addEventListener('gattserverdisconnected', () => log('GATT desconectado.'));
    log('Selecionado: ' + device.name);

    server = await device.gatt.connect();
    setStatus('Conectado. A ler dados...');
    log('GATT conectado.');

    // HR (tentar read; se falhar, usar notify 1x)
    let hr = null;
    try {
      const hrSvc = await server.getPrimaryService(SVC_HR);
      hrChar = await hrSvc.getCharacteristic(CH_HR_ME);
      try {
        const v = await hrChar.readValue();
        hr = parseHeartRate(v);
        log('HR (read): ' + hr + ' bpm');
      } catch (e) {
        log('HR read falhou, a tentar notify 1x...');
        hr = await new Promise(async (resolve, reject) => {
          const handler = (ev) => {
            const dv = ev.target.value;
            const bpm = parseHeartRate(dv);
            resolve(bpm);
          };
          let timeout = setTimeout(() => { try { hrChar.stopNotifications(); } catch{} reject(new Error('Timeout HR notify')); }, 6000);
          await hrChar.startNotifications();
          hrChar.addEventListener('characteristicvaluechanged', (ev) => {
            clearTimeout(timeout);
            try { hrChar.stopNotifications(); } catch{}
            handler(ev);
          }, { once: true });
        });
        log('HR (notify): ' + hr + ' bpm');
      }
    } catch (e) {
      log('HR indispon√≠vel: ' + (e.message || e));
    }
    if (hr!==null){ $hr.textContent = hr; }

    // Bateria
    let batt = null;
    try {
      const bSvc = await server.getPrimaryService(SVC_BATT);
      battChar = await bSvc.getCharacteristic(CH_BATT);
      const v = await battChar.readValue();
      batt = v.getUint8(0);
      log('Bateria: ' + batt + '%');
    } catch (e) {
      log('Bateria indispon√≠vel: ' + (e.message || e));
    }
    if (batt!==null){ $batt.textContent = batt; }

    // Mostrar + notificar
    setStatus('Leitura conclu√≠da.');
    notifyLine($hr.textContent, $batt.textContent);

  } catch (err){
    setStatus('Erro: ' + (err.message || err));
    log('Erro: ' + (err.stack || err));
  } finally {
    // fecha liga√ß√£o para poupar bateria
    await disconnect();
  }
}

document.getElementById('btnOnce').addEventListener('click', readOnce);

// Registrar service worker (PWA)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  });
}
</script>
</body>
</html>