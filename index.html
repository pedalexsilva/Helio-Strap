<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Amazfit HR</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#ffffff" />
<style>
body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans'; padding: 24px; background:#fafafa; color:#111; display:flex; justify-content:center; }
.card { background:#fff; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.08); padding:22px; max-width:560px; width:100%; }
h1 { margin:0 0 8px; font-size:1.6rem; }
p  { margin:0 0 16px; color:#444; }
button { font-size:1.05rem; padding:12px 16px; border-radius:12px; border:0; cursor:pointer; }
button.primary { background:#2563eb; color:#fff; }
#status { margin-top:14px; color:#111; font-size:0.95rem; min-height:1.4em; }
.metrics { font-size:1.4rem; margin-top:12px; }
#log { margin-top:12px; background:#0b1020; color:#a7f3d0; padding:10px; border-radius:10px; font-family:ui-monospace; max-height:200px; overflow:auto; }
</style>
</head>
<body>
<div class="card">
<h1>Amazfit Helio Strap</h1>
<p>Web Bluetooth ‚Ä¢ Chrome Android ‚Ä¢ Leitura √∫nica</p>
<button id="btnOnce" class="primary">üîó Ler HR e Bateria</button>
<div class="metrics">‚ù§Ô∏è <span id="hr">‚Äî</span> bpm &nbsp;|&nbsp; üîã <span id="batt">‚Äî</span>%</div>
<div id="status">Pronto.</div>
<div id="log"></div>
</div>

<script>
const SVC_HR='heart_rate',CH_HR_ME='heart_rate_measurement',SVC_BATT='battery_service',CH_BATT='battery_level';
let device=null,server=null,hrChar=null,battChar=null;
const $hr=document.getElementById('hr'),$batt=document.getElementById('batt'),$status=document.getElementById('status'),$log=document.getElementById('log');

function log(t){console.log(t);$log.textContent+=t+"\\n";$log.scrollTop=$log.scrollHeight;}
function setStatus(t){$status.textContent=t;}

// üîî Pedido de permiss√£o para notifica√ß√µes
async function ensureNotifPermission(){
  if(!('Notification'in window))return false;
  if(Notification.permission==='granted')return true;
  if(Notification.permission!=='denied'){
    const r=await Notification.requestPermission();
    return r==='granted';
  }
  return false;
}

// üîî Mostra notifica√ß√£o (via service worker)
async function notifyLine(hr,batt){
  const msg = `‚ù§Ô∏è ${hr ?? '‚Äî'} bpm | üîã ${batt ?? '‚Äî'}%`;
  try {
    let reg = null;
    if ('serviceWorker' in navigator) {
      reg = await navigator.serviceWorker.ready;
    }
    if (reg && reg.showNotification) {
      await reg.showNotification(msg, {
        body: msg,
        icon: 'icon-192.png',
        badge: 'icon-192.png',
      });
      console.log('üîî Notifica√ß√£o enviada via ServiceWorker.');
      return;
    }
    if ('Notification' in window && Notification.permission === 'granted') {
      new Notification(msg, { body: msg, icon: 'icon-192.png' });
      console.log('üîî Notifica√ß√£o enviada via Notification.');
    } else {
      alert(msg);
    }
  } catch (err) {
    console.error('‚ö†Ô∏è Falha ao mostrar notifica√ß√£o:', err);
    alert(msg);
  }
}

// ‚ù§Ô∏è Decodifica o valor do HR
function parseHeartRate(dv){
  const f=dv.getUint8(0);
  return(f&1)?dv.getUint16(1,true):dv.getUint8(1);
}

// üîå Desconectar
async function disconnect(){
  try{if(device?.gatt?.connected)await device.gatt.disconnect();}catch{}
  device=null;server=null;hrChar=null;battChar=null;
  log('Desconectado.');
}

// ‚ñ∂Ô∏è Leitura √∫nica
async function readOnce(){
  try{
    if(!navigator.bluetooth){alert('Este browser n√£o suporta Web Bluetooth.');return;}
    await ensureNotifPermission();
    setStatus('A procurar o dispositivo...');$log.textContent='';
    device=await navigator.bluetooth.requestDevice({filters:[{namePrefix:'Amazfit'}],optionalServices:[SVC_HR,SVC_BATT]});
    device.addEventListener('gattserverdisconnected',()=>log('GATT desconectado.'));
    log('Selecionado: '+device.name);
    server=await device.gatt.connect();
    setStatus('Conectado. A ler dados...');log('GATT conectado.');

    // ‚ù§Ô∏è Ler HR
    let hr=null;
    try{
      const s=await server.getPrimaryService(SVC_HR);
      hrChar=await s.getCharacteristic(CH_HR_ME);
      try{
        const v=await hrChar.readValue();
        hr=parseHeartRate(v);
        log('HR (read): '+hr+' bpm');
      }catch(e){
        log('HR read falhou, a tentar notify 1x...');
        hr=await new Promise(async(res,rej)=>{
          const h=(ev)=>{
            const bpm=parseHeartRate(ev.target.value);
            res(bpm);
          };
          let to=setTimeout(()=>{
            try{hrChar.stopNotifications();}catch{}
            rej(new Error('Timeout HR notify'));
          },6000);
          await hrChar.startNotifications();
          hrChar.addEventListener('characteristicvaluechanged',h,{once:true});
        });
        log('HR (notify): '+hr+' bpm');
      }
    }catch(e){log('Erro ao ler HR: '+(e.message||e));}
    if(hr!==null)$hr.textContent=hr;

    // üîã Ler Bateria (tenta 2x)
    let batt=null;
    try{
      const bSvc=await server.getPrimaryService(SVC_BATT);
      battChar=await bSvc.getCharacteristic(CH_BATT);
      try{
        const v=await battChar.readValue();
        batt=v.getUint8(0);
      }catch(e1){
        console.warn('1¬™ leitura da bateria falhou, a tentar novamente...');
        await new Promise(r=>setTimeout(r,1000));
        const v2=await battChar.readValue();
        batt=v2.getUint8(0);
      }
      log('Bateria: '+batt+'%');
    }catch(e){log('Bateria indispon√≠vel: '+(e.message||e));}
    if(batt!==null)$batt.textContent=batt;

    // üèÅ Finalizar
    setStatus('Leitura conclu√≠da.');
    await notifyLine($hr.textContent,$batt.textContent);
  }catch(err){
    setStatus('Erro: '+(err.message||err));
    log('Erro: '+(err.stack||err));
  }finally{
    await disconnect();
  }
}

// ‚ñ∂Ô∏è Bot√£o
document.getElementById('btnOnce').addEventListener('click',readOnce);

// üß© Service Worker
if('serviceWorker'in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
</script>
</body>
</html>
